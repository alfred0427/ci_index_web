<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>大盤多空綜合判斷系統</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb; --card-bg:#ffffff; --text:#1f2937; --muted:#6b7280;
      --border:#e5e7eb; --accent:#2563eb; --thead:#eef2ff;
    }
    html,body{background:var(--bg); color:var(--text);}
    .app-navbar{background:var(--card-bg); border-bottom:1px solid var(--border);}
    .app-wrap{max-width:1100px; margin:32px auto; padding:0 16px;}
    .card-elev{background:var(--card-bg); border:1px solid var(--border);
      border-radius:14px; box-shadow:0 4px 14px rgba(0,0,0,.06);}
    .section-title{font-weight:700; margin:0 0 6px 0;}
    .sub-title{color:var(--muted); font-size:.95rem; margin:0 0 14px 0;}
    .block{ margin-bottom:20px; }
    .plot-img{width:100%; height:auto; border:1px solid var(--border);
      border-radius:12px; background:#fff; padding:6px;}
    .table-wrap{max-height:420px; overflow:auto; border:1px solid var(--border);
      border-radius:10px; background:#fff;}
    table{margin:0; background:#fff; border-collapse:separate; border-spacing:0; table-layout:auto;}
    thead th{position:sticky; top:0; z-index:2; background:var(--thead)!important;
      border-bottom:1px solid var(--border)!important;}
    tbody th{position:sticky; left:0; z-index:1; background:#f9fafb;
      border-right:1px solid var(--border); white-space:nowrap;}
    .table>:not(caption)>*>*{padding:.5rem .65rem;}
    .num{ text-align:right; font-variant-numeric: tabular-nums; }
    .neg{ color:#b91c1c; }
    .error{ color:#b91c1c; background:#fee2e2; border:1px solid #fecaca;
      border-radius:10px; padding:10px; font-size:.95rem; margin-top:8px;}
    .skeleton{height:180px; border-radius:10px;
      background:linear-gradient(90deg,#f2f4f7 25%,#e9edf3 37%,#f2f4f7 63%);
      background-size:400% 100%; animation:sheen 1.2s infinite; border:1px solid var(--border);}
    @keyframes sheen{0%{background-position:100% 0}100%{background-position:0 0}}
    .nav-tabs .nav-link{border:0; color:var(--muted);}
    .nav-tabs .nav-link.active{color:var(--accent); font-weight:600; border-bottom:2px solid var(--accent); background:transparent;}
    footer{ color:var(--muted); font-size:.9rem; }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar app-navbar">
    <div class="container-fluid" style="max-width:1100px">
      <span class="navbar-brand mb-0 h1">大盤多空綜合判斷系統 <span>

      <!-- 右上角操作 -->
      <div class="d-flex gap-2 align-items-center">
        <div class="dropdown">
          <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
            下載 CSV
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><h6 class="dropdown-header">Buy</h6></li>
            <li><a class="dropdown-item" href="https://raw.githubusercontent.com/alfred0427/ci_index_web/main/buy_data/main_chart.csv" download>main_chart.csv</a></li>
            <li><a class="dropdown-item" href="https://raw.githubusercontent.com/alfred0427/ci_index_web/main/buy_data/sub1.csv" download>sub1.csv</a></li>
            <li><a class="dropdown-item" href="https://raw.githubusercontent.com/alfred0427/ci_index_web/main/buy_data/sub2.csv" download>sub2.csv</a></li>
            <li><a class="dropdown-item" href="https://raw.githubusercontent.com/alfred0427/ci_index_web/main/buy_data/sub3.csv" download>sub3.csv</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><h6 class="dropdown-header">Sell</h6></li>
            <li><a class="dropdown-item" href="https://raw.githubusercontent.com/alfred0427/ci_index_web/main/sell_data/main_chart.csv" download>main_chart.csv</a></li>
            <li><a class="dropdown-item" href="https://raw.githubusercontent.com/alfred0427/ci_index_web/main/sell_data/sub1.csv" download>sub1.csv</a></li>
            <li><a class="dropdown-item" href="https://raw.githubusercontent.com/alfred0427/ci_index_web/main/sell_data/sub2.csv" download>sub2.csv</a></li>
            <li><a class="dropdown-item" href="https://raw.githubusercontent.com/alfred0427/ci_index_web/main/sell_data/sub3.csv" download>sub3.csv</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><button class="dropdown-item" onclick="downloadAllCSVs()">下載全部（zip）</button></li>
          </ul>
        </div>

        <button class="btn btn-primary btn-sm" onclick="exportCurrentHTML()">
          匯出整頁為 HTML
        </button>
      </div>

      <!-- Tabs -->
      <ul class="nav nav-tabs ms-auto">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-buy">Buy</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-sell">Sell</button></li>
      </ul>
    </div>
  </nav>

  <main class="app-wrap">
    <div class="tab-content">

      <!-- BUY -->
      <div class="tab-pane fade show active" id="tab-buy">
        <div class="card-elev p-4 block">
          <h2 class="section-title">Buy 概覽</h2>
          <p class="sub-title">情境圖</p>
          <img class="plot-img" src="https://raw.githubusercontent.com/alfred0427/ci_index_web/main/buy_data/plot.png" alt="Buy Plot">
        </div>

        <div class="card-elev p-4 block">
          <h5 class="mb-3">Buy · Main Chart</h5>
          <div class="table-wrap" id="main_chart_buy"><div class="skeleton"></div></div>
        </div>

        <div class="card-elev p-4 block">
          <h5 class="mb-3">Buy · Sub1</h5>
          <div class="table-wrap" id="sub1_buy"><div class="skeleton"></div></div>
        </div>

        <div class="card-elev p-4 block">
          <h5 class="mb-3">Buy · Sub2</h5>
          <div class="table-wrap" id="sub2_buy"><div class="skeleton"></div></div>
        </div>

        <div class="card-elev p-4 block">
          <h5 class="mb-3">Buy · Sub3</h5>
          <div class="table-wrap" id="sub3_buy"><div class="skeleton"></div></div>
        </div>
      </div>

      <!-- SELL -->
      <div class="tab-pane fade" id="tab-sell">
        <div class="card-elev p-4 block">
          <h2 class="section-title">Sell 概覽</h2>
          <p class="sub-title">情境圖</p>
          <img class="plot-img" src="https://raw.githubusercontent.com/alfred0427/ci_index_web/main/sell_data/plot.png" alt="Sell Plot">
        </div>

        <div class="card-elev p-4 block">
          <h5 class="mb-3">Sell · Main Chart</h5>
          <div class="table-wrap" id="main_chart_sell"><div class="skeleton"></div></div>
        </div>

        <div class="card-elev p-4 block">
          <h5 class="mb-3">Sell · Sub1</h5>
          <div class="table-wrap" id="sub1_sell"><div class="skeleton"></div></div>
        </div>

        <div class="card-elev p-4 block">
          <h5 class="mb-3">Sell · Sub2</h5>
          <div class="table-wrap" id="sub2_sell"><div class="skeleton"></div></div>
        </div>

        <div class="card-elev p-4 block">
          <h5 class="mb-3">Sell · Sub3</h5>
          <div class="table-wrap" id="sub3_sell"><div class="skeleton"></div></div>
        </div>
      </div>

    </div>

    <footer class="mt-4 text-center">
      © Data Viewer · Minimal Professional Theme
    </footer>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // 下載全部 CSV 成 zip
    async function downloadAllCSVs(){
      const zip = new JSZip();
      const files = [
        {path:'https://raw.githubusercontent.com/alfred0427/ci_index_web/main/buy_data/main_chart.csv', name:'buy_main_chart.csv'},
        {path:'https://raw.githubusercontent.com/alfred0427/ci_index_web/main/buy_data/sub1.csv', name:'buy_sub1.csv'},
        {path:'https://raw.githubusercontent.com/alfred0427/ci_index_web/main/buy_data/sub2.csv', name:'buy_sub2.csv'},
        {path:'https://raw.githubusercontent.com/alfred0427/ci_index_web/main/buy_data/sub3.csv', name:'buy_sub3.csv'},
        {path:'https://raw.githubusercontent.com/alfred0427/ci_index_web/main/sell_data/main_chart.csv', name:'sell_main_chart.csv'},
        {path:'https://raw.githubusercontent.com/alfred0427/ci_index_web/main/sell_data/sub1.csv', name:'sell_sub1.csv'},
        {path:'https://raw.githubusercontent.com/alfred0427/ci_index_web/main/sell_data/sub2.csv', name:'sell_sub2.csv'},
        {path:'https://raw.githubusercontent.com/alfred0427/ci_index_web/main/sell_data/sub3.csv', name:'sell_sub3.csv'}
      ];
      await Promise.all(files.map(async f=>{
        const res = await fetch(f.path, {cache:"no-store"}); 
        const text = await res.text();
        zip.file(f.name, text);
      }));
      const blob = await zip.generateAsync({type:"blob"});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'all_csv.zip'; a.click();
      URL.revokeObjectURL(a.href);
    }

    // 匯出目前整頁為 HTML
    function exportCurrentHTML(){
      const html = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
      const blob = new Blob([html], {type:"text/html;charset=utf-8"});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'export.html'; a.click();
      URL.revokeObjectURL(a.href);
    }

    // 載入 CSV → 表格
    function loadCSV(path, mountId) {
      Papa.parse(path + '?v=' + Date.now(), {
        download: true,
        header: false,
        skipEmptyLines: true,
        complete: ({ data }) => {
          if (!data || !data.length) return showErr(mountId, `讀到空資料：${path}`);
          let html = "<table class='table table-striped table-hover table-sm align-middle mb-0'><thead><tr>";
          data[0].forEach((v, i) => html += i ? `<th>${escapeHtml(v)}</th>` : "<th></th>");
          html += "</tr></thead><tbody>";
          for (let r = 1; r < data.length; r++) {
            html += "<tr>";
            data[r].forEach((v, c) => {
              const cell = escapeHtml(v);
              html += (c === 0) ? `<th scope="row">${cell}</th>` : `<td>${cell}</td>`;
            });
            html += "</tr>";
          }
          html += "</tbody></table>";
          const host = document.getElementById(mountId);
          host.innerHTML = html;
          postProcessTable(host.querySelector('table'));
        },
        error: (err) => {
          showErr(mountId, `無法讀取 ${path}：${err?.message}`);
        }
      });
    }

    // 表格後處理
    function postProcessTable(tbl){
      const rows = Array.from(tbl.tBodies[0]?.rows || []);
      if (!rows.length) return;
      const cols = tbl.tHead.rows[0].cells.length;
      const maxLen = Array(cols).fill(0);
      const numericCol = Array(cols).fill(true);
      const parseNum = (s)=>{const t=String(s).replace(/,/g,'').replace(/\s+/g,'').replace(/%$/,''); return t!=='' && !isNaN(t)?Number(t):null;};
      for (const tr of rows){
        for (let c=0; c<tr.cells.length; c++){
          const td=tr.cells[c]; const text=td.textContent||'';
          maxLen[c]=Math.max(maxLen[c], text.length);
          if (c>0) numericCol[c]=numericCol[c] && (parseNum(text)!==null);
        }
      }
      for (const tr of rows){
        for (let c=1; c<tr.cells.length; c++){
          const td=tr.cells[c];
          if (numericCol[c]){ td.classList.add('num'); const n=parseNum(td.textContent); if (typeof n==='number' && n<0) td.classList.add('neg'); }
        }
      }
      const colgroup=document.createElement('colgroup');
      for (let c=0;c<cols;c++){const col=document.createElement('col');const ch=Math.max(6,Math.min(24,maxLen[c]+1));col.style.minWidth=ch+'ch';colgroup.appendChild(col);}
      tbl.insertBefore(colgroup, tbl.tHead);
    }

    function showErr(mountId, msg) {
      document.getElementById(mountId).innerHTML = `<div class="error">⚠️ ${escapeHtml(msg)}</div>`;
    }
    function escapeHtml(s){return String(s ?? '').replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");}

    // BUY
    loadCSV("https://raw.githubusercontent.com/alfred0427/ci_index_web/main/buy_data/main_chart.csv", "main_chart_buy");
    loadCSV("https://raw.githubusercontent.com/alfred0427/ci_index_web/main/buy_data/sub1.csv", "sub1_buy");
    loadCSV("https://raw.githubusercontent.com/alfred0427/ci_index_web/main/buy_data/sub2.csv", "sub2_buy");
    loadCSV("https://raw.githubusercontent.com/alfred0427/ci_index_web/main/buy_data/sub3.csv", "sub3_buy");

    // SELL
    loadCSV("https://raw.githubusercontent.com/alfred0427/ci_index_web/main/sell_data/main_chart.csv", "main_chart_sell");
    loadCSV("https://raw.githubusercontent.com/alfred0427/ci_index_web/main/sell_data/sub1.csv", "sub1_sell");
    loadCSV("https://raw.githubusercontent.com/alfred0427/ci_index_web/main/sell_data/sub2.csv", "sub2_sell");
    loadCSV("https://raw.githubusercontent.com/alfred0427/ci_index_web/main/sell_data/sub3.csv", "sub3_sell");
  </script>
</body>
</html>
